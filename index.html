<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Vanlife Savings Spots</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
  * { box-sizing: border-box; }

  body {
    margin: 0;
    padding: 0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: #111827;
  }

  #vanlife-app-wrapper {
    width: 100%;
    max-width: 960px;
    margin: 0 auto;
    padding: 10px;
  }

  #vanlife-app {
    width: 100%;
    background: linear-gradient(135deg,#d97742,#b45309);
    padding: 16px;
    border-radius: 16px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.35);
    color: #fff7ed;
  }

  h2 {
    margin: 0 0 4px 0;
    font-size: 1.4rem;
  }

  p {
    margin: 0;
    font-size: 0.9rem;
  }

  #vanlife-map {
    width: 100% !important;
    height: 420px !important;
    border-radius: 12px;
    position: relative;
    overflow: hidden;
    margin-top: 14px;
  }

  #map-overlay {
    position: absolute;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background: rgba(255, 248, 240, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #4b5563;
    font-weight: 600;
    font-size: 1rem;
    border-radius: 12px;
    cursor: pointer;
    text-align: center;
    z-index: 1000;
    padding: 0 16px;
  }

  #status-bar {
    margin-top: 8px;
    font-size: 0.8rem;
    color: #fefce8;
    min-height: 18px;
  }

  #controls-row {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
  }

  .control-button {
    flex: 1 1 140px;
    padding: 8px 10px;
    background:#b45309;
    color:white;
    border:none;
    border-radius:6px;
    cursor:pointer;
    font-size: 0.9rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
  }

  .control-button span {
    font-size: 1.1rem;
  }

  #filters-row {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
    font-size: 0.8rem;
  }

  #filters-row select,
  #filters-row label {
    font-size: 0.8rem;
  }

  #filters-row select {
    padding: 4px 6px;
    border-radius: 6px;
    border: 1px solid #d1d5db;
    background: #fff7ed;
  }

  #wifi-form-wrapper {
    background: #fef3e0;
    padding: 16px;
    border-radius: 12px;
    margin-top: 16px;
    color: #111827;
  }

  #wifi-form label {
    font-size: 0.8rem;
    font-weight: 600;
    display: block;
    margin-bottom: 2px;
  }

  #wifi-form input,
  #wifi-form select,
  #wifi-form textarea {
    width: 100%;
    padding: 6px;
    border-radius: 6px;
    border: 1px solid #d1d5db;
    background: #fff7ed;
    font-size: 0.9rem;
    margin-bottom: 8px;
  }

  #wifi-form textarea {
    resize: vertical;
  }

  #wifi-form button {
    background: #b45309;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    width: 100%;
    cursor: pointer;
    font-size: 0.95rem;
    font-weight: 600;
  }

  .autocomplete-box {
    position: relative;
  }

  .autocomplete-list {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #fff7ed;
    border-radius: 6px;
    border: 1px solid #e5e7eb;
    max-height: 160px;
    overflow-y: auto;
    z-index: 2000;
    font-size: 0.85rem;
  }

  .autocomplete-item {
    padding: 6px 8px;
    cursor: pointer;
  }

  .autocomplete-item:hover {
    background: #fee2e2;
  }

  #toast {
    position: fixed;
    bottom: 16px;
    left: 50%;
    transform: translateX(-50%);
    background: #111827;
    color: #f9fafb;
    padding: 8px 14px;
    border-radius: 999px;
    font-size: 0.85rem;
    box-shadow: 0 6px 16px rgba(0,0,0,0.4);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s ease;
    z-index: 5000;
  }

  #toast.show {
    opacity: 1;
    pointer-events: auto;
  }

  .user-van-icon {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    background: white;
    border: 3px solid #1e90ff;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 0 12px rgba(30,144,255,0.7);
    font-size: 22px;
  }

  .affiliate-links {
    max-width: 700px;
    margin: 16px auto 0 auto;
    padding: 12px;
    background: #fef3e0;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    font-size: 0.85rem;
    color: #374151;
  }

  .affiliate-links a {
    color: #b45309;
    font-weight: 600;
    text-decoration: underline;
  }

  #bmac-button {
    background: #FFF8E1;
    padding: 14px;
    border-radius: 12px;
    text-align: center;
    margin-top: 16px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.2);
    cursor: pointer;
  }

  #bmac-button a {
    text-decoration: none;
  }

  #bmac-button div {
    margin: 0;
  }

  #pin-list {
    margin-top: 10px;
    font-size: 0.8rem;
    max-height: 180px;
    overflow-y: auto;
    background: rgba(17,24,39,0.15);
    border-radius: 8px;
    padding: 6px;
  }

  .pin-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 6px;
    border-radius: 6px;
    background: rgba(15,23,42,0.35);
    margin-bottom: 4px;
  }

  .pin-item span {
    flex: 1;
    margin-right: 6px;
  }

  .pin-actions button {
    border: none;
    border-radius: 4px;
    padding: 2px 6px;
    font-size: 0.7rem;
    cursor: pointer;
    margin-left: 4px;
  }

  .btn-edit { background:#facc15; color:#111827; }
  .btn-delete { background:#ef4444; color:#f9fafb; }

  #advanced-tools-toggle {
    margin-top: 12px;
    background: #92400e;
    color: white;
    padding: 8px 10px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    text-align: center;
  }

  #advanced-tools-panel {
    display: none;
    background: #fef3e0;
    padding: 12px;
    border-radius: 12px;
    margin-top: 8px;
    color: #111827;
  }

  @media (max-width: 640px) {
    #vanlife-app {
      padding: 12px;
    }
    #vanlife-map {
      height: 360px !important;
    }
    .control-button {
      font-size: 0.8rem;
    }
  }
</style>
</head>
<script>
document.addEventListener('DOMContentLoaded', function() {

  let map, markersLayer, userMarker;
  let mapLocked = true;
  let userLatLng = null;
  let userSuburbGuess = '';
  let pins = [];
  let lastSubmitTime = 0;

  const overlay = document.getElementById('map-overlay');
  const statusBar = document.getElementById('status-bar');
  const toast = document.getElementById('toast');
  const pinList = document.getElementById('pin-list');

  const nameInput = document.getElementById('spot-name');
  const addressInput = document.getElementById('spot-address');
  const nameAC = document.getElementById('name-autocomplete');
  const addressAC = document.getElementById('address-autocomplete');

  const filterType = document.getElementById('filter-type');
  const filterFreeWifi = document.getElementById('filter-free-wifi');
  const searchPinsInput = document.getElementById('search-pins');
  const useMapAddressBtn = document.getElementById('use-map-address');

  const advancedToggle = document.getElementById('advanced-tools-toggle');
  const advancedPanel = document.getElementById('advanced-tools-panel');
  const exportBtn = document.getElementById('export-pins');

  const emoji = {
    "Free Camping": '‚õ∫',
    Library: 'üìö',
    "McDonald's": 'üçî',
    Cafe: '‚òï',
    Toilet: 'üöª',
    Park: 'üå≥',
    Showground: 'üèüÔ∏è',
    "Hotel / Motel": 'üè®',
    Other: 'üìç'
  };

  /* DEVICE‚ÄëAWARE DIRECTIONS (APPLE MAPS ON IPHONE, GOOGLE MAPS ELSEWHERE) */
  function getDirectionsURL(rawAddress) {
    const encoded = encodeURIComponent(rawAddress);
    const ua = navigator.userAgent.toLowerCase();

    if (/iphone|ipad|ipod/.test(ua)) {
      return `https://maps.apple.com/?daddr=${encoded}`;
    }

    return `https://www.google.com/maps/dir/?api=1&destination=${encoded}`;
  }

  function showToast(msg) {
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 2200);
  }

  function setStatus(msg) {
    statusBar.textContent = msg || '';
  }

  function createIcon(type, wifi) {
    let iconChar = emoji[type] || 'üìç';
    let wifiBadge = wifi === 'Yes' ? 'üì∂' : '';
    return L.divIcon({
      html: `<div style="font-size:20px;background:white;border-radius:50%;padding:6px;
             box-shadow:0 2px 8px rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;">
               <span>${iconChar}</span><span style="margin-left:2px;font-size:14px;">${wifiBadge}</span>
             </div>`,
      className: '',
      iconSize: [36, 36],
      iconAnchor: [18, 36]
    });
  }

  function userVanIcon() {
    return L.divIcon({
      html: `<div class="user-van-icon">üöê</div>`,
      className: '',
      iconSize: [40, 40],
      iconAnchor: [20, 20]
    });
  }

  /* MAP INITIALISATION */
  map = L.map('vanlife-map', {
    zoomControl: true,
    zoomAnimation: false,
    renderer: L.canvas()
  }).setView([-25.2744, 133.7751], 4);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    updateWhenIdle: true,
    attribution: '¬© OpenStreetMap contributors'
  }).addTo(map);

  markersLayer = L.layerGroup().addTo(map);

  function updateMapLock() {
    if (mapLocked) {
      map.dragging.disable();
      map.touchZoom.disable();
      map.scrollWheelZoom.disable();
      map.boxZoom.disable();
      map.keyboard.disable();
      map.doubleClickZoom.disable();
    } else {
      map.dragging.enable();
      map.touchZoom.enable();
      map.scrollWheelZoom.enable();
      map.boxZoom.enable();
      map.keyboard.enable();
      map.doubleClickZoom.enable();
    }
  }
  updateMapLock();

  /* LOAD + SAVE PINS */
  function loadPins() {
    try {
      const raw = localStorage.getItem('vanlife_pins');
      if (!raw) return;
      pins = JSON.parse(raw) || [];
    } catch(e) {
      pins = [];
    }
  }

  function savePins() {
    localStorage.setItem('vanlife_pins', JSON.stringify(pins));
  }

  function matchesFilters(pin) {
    if (filterType.value && pin.type !== filterType.value) return false;
    if (filterFreeWifi.checked && pin.wifi !== 'Yes') return false;

    const q = searchPinsInput.value.trim().toLowerCase();
    if (!q) return true;

    const haystack = [
      pin.name || '',
      pin.type || '',
      pin.notes || '',
      pin.rawAddress || '',
      pin.suburb || ''
    ].join(' ').toLowerCase();

    return haystack.includes(q);
  }

  function renderPinsOnMap() {
    markersLayer.clearLayers();
    pins.forEach(pin => {
      if (!matchesFilters(pin)) return;

      const marker = L.marker([pin.lat, pin.lng], { icon: createIcon(pin.type, pin.wifi) });

      const directionsURL = getDirectionsURL(pin.rawAddress);

      const popup = `
        <div style="min-width:200px;">
          <b style="color:#b45309;">${pin.name || 'Unnamed spot'}</b><br>
          <b>${pin.type}</b><br>
          Free Wi‚ÄëFi: <span style="color:${pin.wifi === 'Yes' ? 'green' : 'red'}">${pin.wifi}</span><br>
          ${pin.suburb ? `<span>${pin.suburb}</span><br>` : ''}
          ${pin.notes ? `<i>${pin.notes}</i><br>` : ''}<br>
          <a href="${directionsURL}" target="_blank" style="color:#b45309;">
            üì± Directions
          </a>
        </div>
      `;

      marker.bindPopup(popup);
      marker.addTo(markersLayer);
    });
  }

  function renderPinList() {
    const visiblePins = pins.filter(matchesFilters);
    if (!visiblePins.length) {
      pinList.innerHTML = '<div style="color:#e5e7eb;font-size:0.8rem;">No spots match your filters yet.</div>';
      return;
    }
    pinList.innerHTML = '';
    visiblePins.forEach(pin => {
      const div = document.createElement('div');
      div.className = 'pin-item';
      const span = document.createElement('span');
      span.textContent = `${emoji[pin.type] || 'üìç'} ${pin.name || 'Unnamed'} (${pin.type})${pin.suburb ? ' ‚Äì ' + pin.suburb : ''}`;
      const actions = document.createElement('div');
      actions.className = 'pin-actions';

      const btnEdit = document.createElement('button');
      btnEdit.className = 'btn-edit';
      btnEdit.textContent = 'Edit';
      btnEdit.onclick = () => editPin(pin.id);

      const btnDelete = document.createElement('button');
      btnDelete.className = 'btn-delete';
      btnDelete.textContent = 'Delete';
      btnDelete.onclick = () => deletePin(pin.id);

      actions.appendChild(btnEdit);
      actions.appendChild(btnDelete);
      div.appendChild(span);
      div.appendChild(actions);
      pinList.appendChild(div);
    });
  }

  function editPin(id) {
    const idx = pins.findIndex(p => p.id === id);
    if (idx === -1) return;
    const pin = pins[idx];
    document.getElementById('spot-name').value = pin.name;
    document.getElementById('spot-type').value = pin.type;
    document.getElementById('spot-wifi').value = pin.wifi === 'Yes' ? 'Yes ‚Äì Free Wi‚ÄëFi' : 'No Free Wi‚ÄëFi';
    document.getElementById('spot-address').value = pin.rawAddress || '';
    document.getElementById('spot-notes').value = pin.notes || '';
    pins.splice(idx, 1);
    savePins();
    renderPinsOnMap();
    renderPinList();
    showToast('Loaded spot into form for editing');
  }

  function deletePin(id) {
    if (!confirm('Delete this spot?')) return;
    pins = pins.filter(p => p.id !== id);
    savePins();
    renderPinsOnMap();
    renderPinList();
    showToast('Spot deleted');
  }

  loadPins();
  renderPinsOnMap();
  renderPinList();

  /* USER LOCATION */
  function getUserLocation(initial = false) {
    if (!navigator.geolocation) {
      setStatus('Location not supported by this browser.');
      return;
    }
    setStatus('Finding your location‚Ä¶');
    navigator.geolocation.getCurrentPosition(
      async pos => {
        userLatLng = [pos.coords.latitude, pos.coords.longitude];
        setStatus('Location found.');
        if (!userMarker) {
          userMarker = L.marker(userLatLng, { icon: userVanIcon() })
            .addTo(map)
            .bindPopup('Your location');
        } else {
          userMarker.setLatLng(userLatLng);
        }
        if (initial) {
          map.setView(userLatLng, 13);
        }
        userSuburbGuess = await reverseGeocode(userLatLng[0], userLatLng[1]) || '';
      },
      err => {
        setStatus('Location is disabled. Turn on location in your browser settings.');
      },
      { enableHighAccuracy: true, timeout: 8000 }
    );
  }

  getUserLocation(true);

  overlay.addEventListener('click', function() {
    mapLocked = false;
    overlay.style.display = 'none';
    updateMapLock();
    if (userLatLng) {
      map.setView(userLatLng, 13);
      if (userMarker) userMarker.openPopup();
    } else {
      map.setView([-25.2744, 133.7751], 5);
    }
    setTimeout(() => map.invalidateSize(), 200);
  });

  document.getElementById('refresh-location').addEventListener('click', () => {
    if (userLatLng) {
      map.setView(userLatLng, 13);
      if (userMarker) userMarker.openPopup();
    } else {
      getUserLocation(true);
    }
  });

  document.getElementById('show-my-pins').addEventListener('click', () => {
    const visiblePins = pins.filter(matchesFilters);
    if (!visiblePins.length) {
      showToast('No spots match your filters yet.');
      return;
    }
    const group = L.featureGroup(
      visiblePins.map(p => L.marker([p.lat, p.lng]))
    );
    map.fitBounds(group.getBounds().pad(0.3));
  });

  document.getElementById('show-near-me').addEventListener('click', () => {
    if (!userLatLng) {
      showToast('Need your location first.');
      getUserLocation(true);
      return;
    }
    const maxKm = 10;
    const nearPins = pins.filter(p => {
      const d = distanceKm(userLatLng[0], userLatLng[1], p.lat, p.lng);
      return d <= maxKm && matchesFilters(p);
    });
    if (!nearPins.length) {
      showToast('No spots within 10 km that match filters.');
      return;
    }
    const group = L.featureGroup(
      nearPins.map(p => L.marker([p.lat, p.lng]))
    );
    map.fitBounds(group.getBounds().pad(0.3));
  });

  document.getElementById('add-here').addEventListener('click', async () => {
    const centre = map.getCenter();
    const approx = await reverseGeocode(centre.lat, centre.lng);
    if (approx) {
      addressInput.value = approx;
      showToast('Approximate address from map centre added.');
    } else {
      addressInput.value = 'Current location';
      showToast('Form set to your current location ‚Äì add name/type and save.');
    }
  });

  useMapAddressBtn.addEventListener('click', async () => {
    const centre = map.getCenter();
    setStatus('Getting address from map centre‚Ä¶');
    const approx = await reverseGeocode(centre.lat, centre.lng);
    setStatus('');
    if (approx) {
      addressInput.value = approx;
      showToast('Approximate address added from map centre.');
    } else {
      showToast('Could not get address from map centre.');
    }
  });

  function distanceKm(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2-lat1) * Math.PI/180;
    const dLon = (lon2-lon1) * Math.PI/180;
    const a =
      Math.sin(dLat/2) * Math.sin(dLat/2) +
      Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) *
      Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  /* SMART GEOCODER ‚Äî RAW ADDRESS ONLY, NO SUBURB FORCING */
  async function smartGeocode(rawText) {
    const base = 'https://nominatim.openstreetmap.org/search?format=json&limit=1&countrycodes=au';
    const cleaned = rawText.trim();
    if (!cleaned) return null;

    const queries = [];

    queries.push(cleaned);
    queries.push(cleaned + ' Australia');

    if (userLatLng) {
      queries.push(cleaned + ' near ' + userLatLng[0] + ',' + userLatLng[1]);
    }

    const wordCount = cleaned.split(/\s+/).length;
    const suburbKeywords = ['nsw','qld','vic','sa','wa','tas','act','coolangatta','ballina','coffs','byron','gold coast','brisbane','sydney','melbourne'];
    const hasSuburb = suburbKeywords.some(k => cleaned.toLowerCase().includes(k));
    if (wordCount <= 4 && !hasSuburb && userSuburbGuess) {
      queries.push(cleaned + ' ' + userSuburbGuess);
    }

    for (let q of queries) {
      const coords = await tryGeocode(base + '&q=' + encodeURIComponent(q));
      if (coords) return coords;
    }
    return null;
  }

  async function tryGeocode(url) {
    try {
      const res = await fetch(url, { headers: { 'Accept-Language': 'en' } });
      const data = await res.json();
      if (!data || !data.length) return null;
      return [parseFloat(data[0].lat), parseFloat(data[0].lon), data[0].display_name || ''];
    } catch(e) {
      return null;
    }
  }

  async function reverseGeocode(lat, lon) {
    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=14&addressdetails=1`;
    try {
      const res = await fetch(url, { headers: { 'Accept-Language': 'en' } });
      const data = await res.json();
      if (!data || !data.address) return '';
      const a = data.address;
      if (a.road && a.suburb) {
        return `${a.road}, ${a.suburb} ${a.state || ''}`.trim();
      }
      return (a.suburb || a.town || a.city || a.village || a.state || '').trim();
    } catch(e) {
      return '';
    }
  }

  /* ADD PIN FROM FORM ‚Äî RAW ADDRESS FOR DIRECTIONS */
  async function addPinFromForm() {
    const now = Date.now();
    if (now - lastSubmitTime < 1500) {
      showToast('Slow down a little‚Äîspot already added.');
      return;
    }
    lastSubmitTime = now;

    const name = document.getElementById('spot-name').value.trim() || 'Unnamed spot';
    const type = document.getElementById('spot-type').value;
    let wifiVal = document.getElementById('spot-wifi').value;
    let addrText = document.getElementById('spot-address').value.trim();
    const notes = document.getElementById('spot-notes').value.trim();

    if (!type || !wifiVal || !addrText) {
      showToast('Please fill in all required fields.');
      return;
    }

    wifiVal = wifiVal.startsWith('Yes') ? 'Yes' : 'No';

    setStatus('Finding that place‚Ä¶');

        let geo = await smartGeocode(addrText);

    if (!geo) {
      setStatus('');
      showToast('Could not find that place. Try adding suburb or nearby landmark.');
      return;
    }

    const [lat, lng, displayName] = geo;

    const suburb = extractSuburb(displayName);

    const newPin = {
      id: Date.now(),
      name,
      type,
      wifi: wifiVal,
      rawAddress: addrText,   // RAW ADDRESS FOR DIRECTIONS
      lat,
      lng,
      suburb,
      notes
    };

    pins.push(newPin);
    savePins();
    renderPinsOnMap();
    renderPinList();

    document.getElementById('wifi-form').reset();
    setStatus('');
    showToast('Spot added!');
  }

  function extractSuburb(displayName) {
    if (!displayName) return '';
    const parts = displayName.split(',');
    if (parts.length < 2) return '';
    return parts[1].trim();
  }

  document.getElementById('wifi-form').addEventListener('submit', function(e) {
    e.preventDefault();
    addPinFromForm();
  });

  /* AUTOCOMPLETE */
  function setupAutocomplete(inputEl, listEl, type) {
    inputEl.addEventListener('input', async function() {
      const val = inputEl.value.trim();
      if (!val) {
        listEl.innerHTML = '';
        return;
      }

      if (type === 'name') {
        const suggestions = [
          'McDonalds', 'Library', 'Cafe', 'Park', 'Toilet',
          'Showground', 'Hotel', 'Free Camping', 'Rest Area'
        ].filter(x => x.toLowerCase().includes(val.toLowerCase()));

        listEl.innerHTML = suggestions
          .map(s => `<div class="autocomplete-item">${s}</div>`)
          .join('');

        Array.from(listEl.children).forEach(item => {
          item.addEventListener('click', () => {
            inputEl.value = item.textContent;
            listEl.innerHTML = '';
          });
        });
      }

      if (type === 'address') {
        const url = `https://nominatim.openstreetmap.org/search?format=json&limit=5&countrycodes=au&q=${encodeURIComponent(val)}`;
        try {
          const res = await fetch(url, { headers: { 'Accept-Language': 'en' } });
          const data = await res.json();
          listEl.innerHTML = data
            .map(d => `<div class="autocomplete-item">${d.display_name}</div>`)
            .join('');

          Array.from(listEl.children).forEach(item => {
            item.addEventListener('click', () => {
              inputEl.value = item.textContent;
              listEl.innerHTML = '';
            });
          });
        } catch(e) {
          listEl.innerHTML = '';
        }
      }
    });
  }

  setupAutocomplete(nameInput, nameAC, 'name');
  setupAutocomplete(addressInput, addressAC, 'address');

  /* FILTERS */
  filterType.addEventListener('change', () => {
    renderPinsOnMap();
    renderPinList();
  });

  filterFreeWifi.addEventListener('change', () => {
    renderPinsOnMap();
    renderPinList();
  });

  searchPinsInput.addEventListener('input', () => {
    renderPinsOnMap();
    renderPinList();
  });

  /* ADVANCED TOOLS */
  advancedToggle.addEventListener('click', () => {
    advancedPanel.style.display =
      advancedPanel.style.display === 'none' ? 'block' : 'none';
  });

  exportBtn.addEventListener('click', () => {
    const data = JSON.stringify(pins, null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = 'vanlife-spots.json';
    a.click();

    URL.revokeObjectURL(url);
    showToast('Exported your spots!');
  });

});
</script>

<body>
<div id="vanlife-app-wrapper">

  <div id="vanlife-app">

    <h2>Vanlife Savings Spots</h2>
    <p>Find free Wi‚ÄëFi, safe overnight parking, libraries, cafes, toilets, and more.</p>

    <!-- MAP -->
    <div id="vanlife-map">
      <div id="map-overlay">Tap to unlock map</div>
    </div>

    <!-- STATUS BAR -->
    <div id="status-bar"></div>

    <!-- CONTROLS -->
    <div id="controls-row">
      <button id="refresh-location" class="control-button"><span>üìç</span> My Location</button>
      <button id="show-my-pins" class="control-button"><span>üìå</span> My Spots</button>
      <button id="show-near-me" class="control-button"><span>üì°</span> Near Me</button>
      <button id="add-here" class="control-button"><span>‚ûï</span> Add Here</button>
    </div>

    <!-- FILTERS -->
    <div id="filters-row">
      <label>Type:</label>
      <select id="filter-type">
        <option value="">All</option>
        <option>Free Camping</option>
        <option>Library</option>
        <option>McDonald's</option>
        <option>Cafe</option>
        <option>Toilet</option>
        <option>Park</option>
        <option>Showground</option>
        <option>Hotel / Motel</option>
        <option>Other</option>
      </select>

      <label><input type="checkbox" id="filter-free-wifi"> Free Wi‚ÄëFi</label>

      <input id="search-pins" type="text" placeholder="Search spots‚Ä¶" style="flex:1; padding:4px 6px; border-radius:6px; border:1px solid #d1d5db;">
    </div>

    <!-- ADD SPOT FORM -->
    <div id="wifi-form-wrapper">
      <form id="wifi-form">

        <label for="spot-name">Spot Name</label>
        <div class="autocomplete-box">
          <input id="spot-name" type="text" placeholder="e.g., McDonalds, Library, Park">
          <div id="name-autocomplete" class="autocomplete-list"></div>
        </div>

        <label for="spot-type">Type</label>
        <select id="spot-type">
          <option value="">Select type‚Ä¶</option>
          <option>Free Camping</option>
          <option>Library</option>
          <option>McDonald's</option>
          <option>Cafe</option>
          <option>Toilet</option>
          <option>Park</option>
          <option>Showground</option>
          <option>Hotel / Motel</option>
          <option>Other</option>
        </select>

        <label for="spot-wifi">Free Wi‚ÄëFi?</label>
        <select id="spot-wifi">
          <option value="">Select‚Ä¶</option>
          <option>Yes ‚Äì Free Wi‚ÄëFi</option>
          <option>No Free Wi‚ÄëFi</option>
        </select>

        <label for="spot-address">Address</label>
        <div class="autocomplete-box">
          <input id="spot-address" type="text" placeholder="Exact address, business name, or corner">
          <div id="address-autocomplete" class="autocomplete-list"></div>
        </div>

        <button type="button" id="use-map-address" style="margin-bottom:8px; background:#92400e;">Use Map Centre Address</button>

        <label for="spot-notes">Notes</label>
        <textarea id="spot-notes" rows="2" placeholder="Optional notes‚Ä¶"></textarea>

        <button type="submit">Save Spot</button>
      </form>
    </div>

    <!-- PIN LIST -->
    <div id="pin-list"></div>

    <!-- ADVANCED TOOLS -->
    <div id="advanced-tools-toggle">Advanced Tools</div>
    <div id="advanced-tools-panel">
      <button id="export-pins" class="control-button" style="width:100%;">Export My Spots</button>
    </div>

    <!-- AFFILIATE LINKS -->
    <div class="affiliate-links">
      <p>Recommended gear for vanlife:</p>
      <p>
        <a href="#">Portable Wi‚ÄëFi</a> ‚Ä¢
        <a href="#">Solar Panels</a> ‚Ä¢
        <a href="#">12V Fridge</a>
      </p>
    </div>

    <!-- BUY ME A COFFEE -->
    <div id="bmac-button">
      <a href="https://www.buymeacoffee.com/" target="_blank">
        <div>‚òï Support the project</div>
      </a>
    </div>

  </div>
</div>

<div id="toast"></div>
</body>
</html>

