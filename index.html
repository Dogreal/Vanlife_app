<!-- Vanlife Savings Spots App -->

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<div id="vanlife-app-wrapper">
  <div id="vanlife-app">

    <div style="color:white; text-align:center; margin-bottom:20px;">
      <h2>Vanlife Savings Spots</h2>
      <p>Find and save your favorite vanlife spots on the map.</p>
    </div>

    <!-- MAP + UNLOCK OVERLAY -->
    <div id="vanlife-map">
      <div id="map-overlay">Tap to Unlock Map</div>
    </div>

    <button id="refresh-location">üìç Re-center Map</button>

    <!-- FORM -->
    <div style="background: #fef3e0; padding: 20px; border-radius: 12px; margin-top: 20px;">
      <form id="wifi-form">
        <input id="spot-name" placeholder="Spot name" required><br><br>

        <select id="spot-type" required>
          <option value="">Type</option>
          <option value="Library">Library</option>
          <option value="McDonald's">McDonald's</option>
          <option value="Cafe">Cafe</option>
          <option value="Toilet">Toilet</option>
          <option value="Park">Park</option>
          <option value="Showground">Showground</option>
          <option value="Other">Other</option>
        </select><br><br>

        <select id="spot-wifi" required>
          <option value="">Wi-Fi?</option>
          <option value="Yes">Yes</option>
          <option value="No">No</option>
        </select><br><br>

        <input id="spot-address" placeholder="Describe or type the place (e.g. 'maccas near the beach in Coolangatta')" required><br><br>
        <textarea id="spot-notes" rows="2" placeholder="Notes or tips (optional)"></textarea><br><br>

        <button type="submit">Add Spot</button>
      </form>
    </div>

    <!-- BUY ME A COFFEE -->
    <div id="bmac-button" style="
      background: #FFF8E1;
      padding: 14px;
      border-radius: 12px;
      text-align: center;
      margin-top: 20px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.15);
      cursor: pointer;
    ">
      <a href="https://buymeacoffee.com/retiredtovanlife" target="_blank" style="text-decoration:none;">
        <div style="font-size: 18px; color: #000000; font-weight: bold; margin-bottom: 6px;">‚òï Enjoying this tool?</div>
        <div style="font-size: 16px; color: #a17451; font-weight: normal; margin-bottom: 4px;">Support the project</div>
        <div style="font-size: 20px; color: #8b5e3c; font-weight: bold;">Buy Me A Coffee</div>
      </a>
    </div>

  </div>

  <!-- AFFILIATE LINKS -->
  <div class="affiliate-links">
    <p><a href="https://tripwizard.rvlife.com/#6977ed8b6fabf" target="_blank">Plan your RV trip with RVLife Trip Wizard</a></p>
    <p><a href="https://starterstopper.com" target="_blank">Get 5% off your StarterStopper immobilizer ‚Äî use promo code <b>RTV5</b></a></p>
    <p style="color:#555;font-size:12px;">As an affiliate, I earn from qualifying purchases at no extra cost to you.</p>
  </div>
</div>

<style>
  #vanlife-app-wrapper {
    width: 95%;
    max-width: 900px;
    margin: auto;
    font-family: sans-serif;
  }

  #vanlife-app {
    width: 100%;
    background: linear-gradient(135deg,#d97742,#b45309);
    padding: 20px;
    border-radius: 16px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.3);
  }

  #vanlife-map {
    width: 100% !important;
    height: 420px !important;
    border-radius: 12px;
    position: relative;
    overflow: hidden;
  }

  /* Overlay sits ON TOP of the live map */
  #map-overlay {
    position: absolute;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background: rgba(255, 248, 240, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #555;
    font-weight: bold;
    font-size: 18px;
    border-radius: 12px;
    cursor: pointer;
    text-align: center;
    z-index: 1000;
  }

  .affiliate-links {
    max-width: 600px;
    margin: 20px auto;
    padding: 12px;
    background: #fef3e0;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    font-size: 14px;
  }

  .affiliate-links a {
    color: #b45309;
    font-weight: bold;
    text-decoration: underline;
  }

  #refresh-location {
    display:inline-block;
    margin-top:10px;
    padding:8px 14px;
    background:#b45309;
    color:white;
    border:none;
    border-radius:6px;
    cursor:pointer;
  }

  #wifi-form input,
  #wifi-form select,
  #wifi-form textarea {
    width: 100%;
    padding: 6px;
    border-radius: 6px;
    border: 1px solid #ccc;
    background: #fff8f0;
  }

  #wifi-form button {
    background: #b45309;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    width: 100%;
    cursor: pointer;
  }

  /* Blue van user icon + location ring */
  .user-van-icon {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    background: white;
    border: 3px solid #1e90ff;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 0 12px rgba(30,144,255,0.7);
    font-size: 22px;
  }
</style>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  let map, markers, userMarker;
  let mapLocked = true;
  let userLatLng = null;

  const overlay = document.getElementById('map-overlay');

  const emoji = {
    Library: 'üìö',
    "McDonald's": 'üçî',
    Cafe: '‚òï',
    Toilet: 'üöª',
    Park: 'üå≥',
    Showground: 'üèüÔ∏è',
    Other: 'üìç'
  };

  function createIcon(type, pulse = false) {
    return L.divIcon({
      html: `<div style="font-size:24px;background:white;border-radius:50%;padding:8px;
             box-shadow:0 2px 8px rgba(0,0,0,0.3)">${emoji[type] || 'üìç'}</div>`,
      className: '',
      iconSize: [40, 40],
      iconAnchor: [20, 40]
    });
  }

  /* USER VAN ICON */
  function userVanIcon() {
    return L.divIcon({
      html: `<div class="user-van-icon">üöê</div>`,
      className: '',
      iconSize: [40, 40],
      iconAnchor: [20, 20]
    });
  }

  /* CREATE MAP IMMEDIATELY (under overlay) */
  map = L.map('vanlife-map', {
    zoomControl: true,
    zoomAnimation: false,
    renderer: L.canvas()
  }).setView([-25.2744, 133.7751], 4);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    updateWhenIdle: true,
    attribution: '¬© OpenStreetMap contributors'
  }).addTo(map);

  markers = L.layerGroup().addTo(map);

  /* LOCK MAP UNTIL UNLOCKED */
  function updateMapLock() {
    if (mapLocked) {
      map.dragging.disable();
      map.touchZoom.disable();
      map.scrollWheelZoom.disable();
      map.boxZoom.disable();
      map.keyboard.disable();
      map.doubleClickZoom.disable();
    } else {
      map.dragging.enable();
      map.touchZoom.enable();
      map.scrollWheelZoom.enable();
      map.boxZoom.enable();
      map.keyboard.enable();
      map.doubleClickZoom.enable();
    }
  }

  updateMapLock();

  /* GET USER LOCATION */
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      userLatLng = [pos.coords.latitude, pos.coords.longitude];

      userMarker = L.marker(userLatLng, { icon: userVanIcon() })
        .addTo(map)
        .bindPopup('Your Location');
    });
  }

  /* UNLOCK MAP ‚Üí CENTER ON USER IF AVAILABLE */
  overlay.addEventListener('click', function() {
    mapLocked = false;
    overlay.style.display = 'none';
    updateMapLock();

    if (userLatLng) {
      map.setView(userLatLng, 13);
      if (userMarker) userMarker.openPopup();
    } else {
      // If no user location, just zoom into Australia a bit more
      map.setView([-25.2744, 133.7751], 5);
    }

    setTimeout(() => map.invalidateSize(), 200);
  });

  /* SMART HUMAN-FRIENDLY GEOCODER */
  async function smartGeocode(rawText) {
    const base = 'https://nominatim.openstreetmap.org/search?format=json&limit=1&countrycodes=au';

    // 1) Try raw text as-is (Nominatim is pretty tolerant)
    let url1 = `${base}&q=${encodeURIComponent(rawText)}`;
    let coords = await tryGeocode(url1);
    if (coords) return coords;

    // 2) If we know user location, bias search near them
    if (userLatLng) {
      const nearText = `${rawText} near ${userLatLng[0]}, ${userLatLng[1]}`;
      let url2 = `${base}&q=${encodeURIComponent(nearText)}`;
      coords = await tryGeocode(url2);
      if (coords) return coords;
    }

    // 3) Fallback: use last 2‚Äì3 words (often suburb/area)
    const tokens = rawText.split(/\s+/).filter(t => t.length > 2);
    if (tokens.length >= 2) {
      const tail = tokens.slice(-3).join(' ');
      let url3 = `${base}&q=${encodeURIComponent(tail)}`;
      coords = await tryGeocode(url3);
      if (coords) return coords;
    }

    return null;
  }

  async function tryGeocode(url) {
    try {
      const res = await fetch(url, {
        headers: {
          'Accept-Language': 'en'
        }
      });
      const data = await res.json();
      if (!data || !data.length) return null;
      return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
    } catch (e) {
      return null;
    }
  }

  /* ADD PIN */
  async function addPin(addrText, name, type, wifi, notes, focus = false) {
    const coords = await smartGeocode(addrText);
    if (!coords) {
      alert("‚ùå Couldn't find that place. Try adding a nearby suburb or landmark name.");
      return;
    }

    const popup = `
      <div style="min-width:200px;">
        <b style="color:#b45309;">${name}</b><br>
        <b>${type}</b><br>
        Wi-Fi: <span style="color:${wifi === 'Yes' ? 'green' : 'red'}">${wifi}</span><br>
        ${notes ? `<i>${notes}</i>` : ''}<br><br>
        <a href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(addrText)}"
           target="_blank"
           style="color:#b45309;">
          üì± Directions
        </a>
      </div>
    `;

    L.marker(coords, { icon: createIcon(type, true) })
      .addTo(markers)
      .bindPopup(popup);

    if (focus) {
      map.setView(coords, 13);
    }
  }

  /* FORM SUBMIT */
  document.getElementById('wifi-form').addEventListener('submit', async e => {
    e.preventDefault();

    const name = document.getElementById('spot-name').value.trim() || 'Unnamed spot';
    const type = document.getElementById('spot-type').value;
    const wifi = document.getElementById('spot-wifi').value;
    const addrText = document.getElementById('spot-address').value.trim();
    const notes = document.getElementById('spot-notes').value.trim();

    await addPin(addrText, name, type, wifi, notes, true);

    e.target.reset();
    map.invalidateSize();
  });

  /* RECENTER BUTTON */
  document.getElementById('refresh-location').addEventListener('click', () => {
    if (userLatLng) {
      map.setView(userLatLng, 13);
      if (userMarker) userMarker.openPopup();
    } else {
      alert('User location not available. Check browser location permissions.');
    }
  });

  window.addEventListener('resize', () => map.invalidateSize());
});
</script>
