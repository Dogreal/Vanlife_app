<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Vanlife Savings Spots</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
  * { box-sizing: border-box; }

  body {
    margin: 0;
    padding: 0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: #111827;
  }

  #vanlife-app-wrapper {
    width: 100%;
    max-width: 960px;
    margin: 0 auto;
    padding: 10px;
  }

  #vanlife-app {
    width: 100%;
    background: linear-gradient(135deg,#d97742,#b45309);
    padding: 16px;
    border-radius: 16px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.35);
    color: #fff7ed;
  }

  h2 {
    margin: 0 0 4px 0;
    font-size: 1.4rem;
  }

  p {
    margin: 0;
    font-size: 0.9rem;
  }

  #vanlife-map {
    width: 100% !important;
    height: 420px !important;
    border-radius: 12px;
    position: relative;
    overflow: hidden;
    margin-top: 14px;
  }

  #map-overlay {
    position: absolute;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background: rgba(255, 248, 240, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #4b5563;
    font-weight: 600;
    font-size: 1rem;
    border-radius: 12px;
    cursor: pointer;
    text-align: center;
    z-index: 1000;
    padding: 0 16px;
  }

  #status-bar {
    margin-top: 8px;
    font-size: 0.8rem;
    color: #fefce8;
    min-height: 18px;
  }

  #controls-row {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
  }

  .control-button {
    flex: 1 1 140px;
    padding: 8px 10px;
    background:#b45309;
    color:white;
    border:none;
    border-radius:6px;
    cursor:pointer;
    font-size: 0.9rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
  }

  .control-button span {
    font-size: 1.1rem;
  }

  #filters-row {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
    font-size: 0.8rem;
  }

  #filters-row select,
  #filters-row label {
    font-size: 0.8rem;
  }

  #filters-row select {
    padding: 4px 6px;
    border-radius: 6px;
    border: 1px solid #d1d5db;
    background: #fff7ed;
  }

  #wifi-form-wrapper {
    background: #fef3e0;
    padding: 16px;
    border-radius: 12px;
    margin-top: 16px;
    color: #111827;
  }

  #wifi-form label {
    font-size: 0.8rem;
    font-weight: 600;
    display: block;
    margin-bottom: 2px;
  }

  #wifi-form input,
  #wifi-form select,
  #wifi-form textarea {
    width: 100%;
    padding: 6px;
    border-radius: 6px;
    border: 1px solid #d1d5db;
    background: #fff7ed;
    font-size: 0.9rem;
    margin-bottom: 8px;
  }

  #wifi-form textarea {
    resize: vertical;
  }

  #wifi-form button {
    background: #b45309;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    width: 100%;
    cursor: pointer;
    font-size: 0.95rem;
    font-weight: 600;
  }

  .autocomplete-box {
    position: relative;
  }

  .autocomplete-list {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #fff7ed;
    border-radius: 6px;
    border: 1px solid #e5e7eb;
    max-height: 160px;
    overflow-y: auto;
    z-index: 2000;
    font-size: 0.85rem;
  }

  .autocomplete-item {
    padding: 6px 8px;
    cursor: pointer;
  }

  .autocomplete-item:hover {
    background: #fee2e2;
  }

  #toast {
    position: fixed;
    bottom: 16px;
    left: 50%;
    transform: translateX(-50%);
    background: #111827;
    color: #f9fafb;
    padding: 8px 14px;
    border-radius: 999px;
    font-size: 0.85rem;
    box-shadow: 0 6px 16px rgba(0,0,0,0.4);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s ease;
    z-index: 5000;
  }

  #toast.show {
    opacity: 1;
    pointer-events: auto;
  }

  .user-van-icon {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    background: white;
    border: 3px solid #1e90ff;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 0 12px rgba(30,144,255,0.7);
    font-size: 22px;
  }

  .affiliate-links {
    max-width: 700px;
    margin: 16px auto 0 auto;
    padding: 12px;
    background: #fef3e0;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    font-size: 0.85rem;
    color: #374151;
  }

  .affiliate-links a {
    color: #b45309;
    font-weight: 600;
    text-decoration: underline;
  }

  #bmac-button {
    background: #FFF8E1;
    padding: 14px;
    border-radius: 12px;
    text-align: center;
    margin-top: 16px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.2);
    cursor: pointer;
  }

  #bmac-button a {
    text-decoration: none;
  }

  #bmac-button div {
    margin: 0;
  }

  #pin-list {
    margin-top: 10px;
    font-size: 0.8rem;
    max-height: 180px;
    overflow-y: auto;
    background: rgba(17,24,39,0.15);
    border-radius: 8px;
    padding: 6px;
  }

  .pin-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 6px;
    border-radius: 6px;
    background: rgba(15,23,42,0.35);
    margin-bottom: 4px;
  }

  .pin-item span {
    flex: 1;
    margin-right: 6px;
  }

  .pin-actions button {
    border: none;
    border-radius: 4px;
    padding: 2px 6px;
    font-size: 0.7rem;
    cursor: pointer;
    margin-left: 4px;
  }

  .btn-edit { background:#facc15; color:#111827; }
  .btn-delete { background:#ef4444; color:#f9fafb; }

  #advanced-tools-toggle {
    margin-top: 12px;
    background: #92400e;
    color: white;
    padding: 8px 10px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    text-align: center;
  }

  #advanced-tools-panel {
    display: none;
    background: #fef3e0;
    padding: 12px;
    border-radius: 12px;
    margin-top: 8px;
    color: #111827;
  }

  @media (max-width: 640px) {
    #vanlife-app {
      padding: 12px;
    }
    #vanlife-map {
      height: 360px !important;
    }
    .control-button {
      font-size: 0.8rem;
    }
  }
</style>
</head>
<body>

<div id="vanlife-app-wrapper">
  <div id="vanlife-app">
    <div style="text-align:center;">
      <h2>Vanlife Savings Spots</h2>
      <p>Find free Wi‚ÄëFi, free camping, cheap cafes, libraries, toilets and traveller‚Äëfriendly spots across Australia ‚Äî especially for retirees and over‚Äë50s planning practical vanlife.</p>
    </div>

    <div id="vanlife-map">
      <div id="map-overlay">Tap to unlock and explore the map</div>
    </div>

    <!-- Related posts + micro SEO block -->
    <div class="related-posts" style="background:#fef3e0;margin-top:16px;padding:12px;border-radius:12px;color:#111827;">
      <h3 style="margin-top:0;font-size:1rem;color:#b45309;">Vanlife Guides & Tips</h3>
      <ul style="margin:0;padding-left:18px;font-size:0.9rem;line-height:1.4;">
        <li><a href="https://retiretovanlife.com/free-camping-vs-overnight-parking-australia/" target="_blank" style="color:#b45309;">Free Camping vs Overnight Parking in Australia</a></li>
        <li><a href="https://retiretovanlife.com/vanlife-prep-checklist/" target="_blank" style="color:#b45309;">Vanlife Prep Checklist</a></li>
        <li><a href="https://retiretovanlife.com/van-life-costs/" target="_blank" style="color:#b45309;">How Much Does Van Life Actually Cost?</a></li>
      </ul>

      <p style="margin-top:10px;font-size:0.8rem;color:#374151;">
        This free vanlife map helps retirees, nomads, and budget travellers find free Wi‚ÄëFi, free camping, safe overnight parking, cheap cafes, libraries, toilets, and traveller‚Äëfriendly spots across Australia.
      </p>
    </div>

    <div id="status-bar"></div>

    <div id="controls-row">
      <button id="refresh-location" class="control-button"><span>üìç</span> Locate Me</button>
      <button id="show-my-pins" class="control-button"><span>‚≠ê</span> My Saved Spots</button>
      <button id="show-near-me" class="control-button"><span>üì°</span> Spots Near Me</button>
      <button id="add-here" class="control-button"><span>‚ûï</span> Add Spot Here</button>
      <button id="ask-ai" class="control-button"><span>ü§ñ</span> Ask AI </button>
    </div>

    <div id="filters-row">
      <div>
        <label for="filter-type"><b>Type filter:</b></label>
        <select id="filter-type">
          <option value="">All types</option>
          <option value="Free Camping">Free Camping</option>
          <option value="Library">Library</option>
          <option value="McDonald's">McDonald's</option>
          <option value="Cafe">Cafe</option>
          <option value="Toilet">Toilet</option>
          <option value="Park">Park</option>
          <option value="Showground">Showground</option>
          <option value="Hotel / Motel">Hotel / Motel</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div>
        <label><input type="checkbox" id="filter-free-wifi" /> Free Wi‚ÄëFi only</label>
      </div>
      <div style="flex:1;">
        <label for="search-pins"><b>Search spots:</b></label>
        <input id="search-pins" placeholder="Search by name, type, notes, suburb‚Ä¶" style="width:100%;padding:4px 6px;border-radius:6px;border:1px solid #d1d5db;background:#fff7ed;font-size:0.8rem;" />
      </div>
    </div>

    <!-- Advanced Tools Toggle -->
    <div id="advanced-tools-toggle">Advanced Tools ‚ñº</div>
    <div id="advanced-tools-panel">
      <button id="export-pins" class="control-button" style="width:100%;background:#b45309;">‚¨áÔ∏è Export My Spots</button>
    </div>

    <div id="wifi-form-wrapper">
      <form id="wifi-form">
        <label for="spot-name">Spot name</label>
        <div class="autocomplete-box">
          <input id="spot-name" placeholder="e.g. McDonalds Coolangatta, Beach Cafe, Library" required />
          <div id="name-autocomplete" class="autocomplete-list" style="display:none;"></div>
        </div>

        <label for="spot-type">Type</label>
        <select id="spot-type" required>
          <option value="">Choose type</option>
          <option value="Free Camping">Free Camping</option>
          <option value="Library">Library</option>
          <option value="McDonald's">McDonald's</option>
          <option value="Cafe">Cafe</option>
          <option value="Toilet">Toilet</option>
          <option value="Park">Park</option>
          <option value="Rest Area">Rest Area</option>
          <option value="Showground">Showground</option>
          <option value="Hotel / Motel">Hotel / Motel</option>
          <option value="Other">Other</option>
        </select>

        <label for="spot-wifi">Free Wi‚ÄëFi available?</label>
        <select id="spot-wifi" required>
          <option value="">Select</option>
          <option value="Yes">Yes ‚Äì Free Wi‚ÄëFi</option>
          <option value="No">No Free Wi‚ÄëFi</option>
        </select>

        <label for="spot-address">Location (ENTER POSTCODE LOCATION)</label>
        <div class="autocomplete-box">
          <input id="spot-address" placeholder="e.g. Postcode" required />
          <div id="address-autocomplete" class="autocomplete-list" style="display:none;"></div>
        </div>
        <button type="button" id="use-map-address" style="margin-bottom:8px;background:#92400e;color:#fff;border:none;border-radius:6px;padding:6px 10px;font-size:0.8rem;cursor:pointer;">
          üìá Use map centre address
        </button>

        <!-- NEW COORDINATES FIELD -->
        <label for="spot-coords">GPS Coordinates (Enter Correctly See Example)</label>
        <input id="spot-coords" placeholder="e.g. -28.28757, 151.95112" />

        <label for="spot-notes">Notes or tips (optional)</label>
        <textarea id="spot-notes" rows="2" placeholder="Add tips like Wi‚ÄëFi strength, parking, shade, safety, noise level, power points, toilets, or vanlife‚Äëfriendly features."></textarea>

        <button type="submit">Add Spot</button>
      </form>
    </div>

    <div id="pin-list"></div>

    <div id="bmac-button">
      <a href="https://buymeacoffee.com/retiredtovanlife" target="_blank">
        <div style="font-size: 18px; color: #000000; font-weight: bold; margin-bottom: 6px;">‚òï Enjoying this tool?</div>
        <div style="font-size: 16px; color: #a17451; font-weight: normal; margin-bottom: 4px;">Support future upgrades</div>
        <div style="font-size: 20px; color: #8b5e3c; font-weight: bold;">Buy Me A Coffee</div>
      </a>
    </div>
  </div>

  <div class="affiliate-links">
    <p><a href="https://tripwizard.rvlife.com/#6977ed8b6fabf" target="_blank">Plan your RV trip with RVLife Trip Wizard</a></p>
    <p><a href="https://starterstopper.com" target="_blank">Get 5% off your StarterStopper immobilizer ‚Äî use promo code <b>RTV5</b></a></p>
    <p style="color:#555;font-size:12px;">As an affiliate, I earn from qualifying purchases at no extra cost to you.</p>
  </div>
</div>

<div id="toast"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {

  let map, markersLayer, userMarker;
  let mapLocked = true;
  let userLatLng = null;
  let userSuburbGuess = '';
  let pins = [];
  let lastSubmitTime = 0;

  const overlay = document.getElementById('map-overlay');
  const statusBar = document.getElementById('status-bar');
  const toast = document.getElementById('toast');
  const pinList = document.getElementById('pin-list');

  const nameInput = document.getElementById('spot-name');
  const addressInput = document.getElementById('spot-address');
  const nameAC = document.getElementById('name-autocomplete');
  const addressAC = document.getElementById('address-autocomplete');

  const filterType = document.getElementById('filter-type');
  const filterFreeWifi = document.getElementById('filter-free-wifi');
  const searchPinsInput = document.getElementById('search-pins');
  const useMapAddressBtn = document.getElementById('use-map-address');

  const emoji = {
    "Free Camping": '‚õ∫',
    Library: 'üìö',
    "McDonald's": 'üçî',
    Cafe: '‚òï',
    Toilet: 'üöª',
    Park: 'üå≥',
    Showground: 'üèüÔ∏è',
    "Hotel / Motel": 'üè®',
    Other: 'üìç'
  };

  const commonNames = [
    "McDonalds Coolangatta",
    "McDonalds Ballina",
    "McDonalds Coffs Harbour",
    "Coolangatta Library",
    "Ballina Library",
    "Beach Cafe Coolangatta",
    "Surf Club Coolangatta",
    "Public Toilet Coolangatta",
    "Free Camping Area",
    "Showground Camping"
  ];

  const commonAddresses = [
    "123 Marine Parade Coolangatta",
    "Coolangatta QLD",
    "Ballina NSW",
    "Coffs Harbour NSW",
    "Gold Coast QLD",
    "free wifi near Coolangatta",
    "library in Ballina",
    "cafe near the beach in Coolangatta"
  ];

  function showToast(msg) {
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 2200);
  }

  function setStatus(msg) {
    statusBar.textContent = msg || '';
  }

  function createIcon(type, wifi) {
    let iconChar = emoji[type] || 'üìç';
    let wifiBadge = wifi === 'Yes' ? 'üì∂' : '';
    return L.divIcon({
      html: `<div style="font-size:20px;background:white;border-radius:50%;padding:6px;
             box-shadow:0 2px 8px rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;">
               <span>${iconChar}</span><span style="margin-left:2px;font-size:14px;">${wifiBadge}</span>
             </div>`,
      className: '',
      iconSize: [36, 36],
      iconAnchor: [18, 36]
    });
  }

  function userVanIcon() {
    return L.divIcon({
      html: `<div class="user-van-icon">üöê</div>`,
      className: '',
      iconSize: [40, 40],
      iconAnchor: [20, 20]
    });
  }

  map = L.map('vanlife-map', {
    zoomControl: true,
    zoomAnimation: false,
    renderer: L.canvas()
  }).setView([-25.2744, 133.7751], 4);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    updateWhenIdle: true,
    attribution: '¬© OpenStreetMap contributors'
  }).addTo(map);

  markersLayer = L.layerGroup().addTo(map);

  function updateMapLock() {
    if (mapLocked) {
      map.dragging.disable();
      map.touchZoom.disable();
      map.scrollWheelZoom.disable();
      map.boxZoom.disable();
      map.keyboard.disable();
      map.doubleClickZoom.disable();
    } else {
      map.dragging.enable();
      map.touchZoom.enable();
      map.scrollWheelZoom.enable();
      map.boxZoom.enable();
      map.keyboard.enable();
      map.doubleClickZoom.enable();
    }
  }
  updateMapLock();

  function loadPins() {
    try {
      const raw = localStorage.getItem('vanlife_pins');
      if (!raw) return;
      pins = JSON.parse(raw) || [];
    } catch(e) {
      pins = [];
    }
  }

  function savePins() {
    localStorage.setItem('vanlife_pins', JSON.stringify(pins));
  }

  function matchesFilters(pin) {
    if (filterType.value && pin.type !== filterType.value) return false;
    if (filterFreeWifi.checked && pin.wifi !== 'Yes') return false;

    const q = searchPinsInput.value.trim().toLowerCase();
    if (!q) return true;

    const haystack = [
      pin.name || '',
      pin.type || '',
      pin.notes || '',
      pin.rawAddress || '',
      pin.suburb || ''
    ].join(' ').toLowerCase();

    return haystack.includes(q);
  }

  function renderPinsOnMap() {
    markersLayer.clearLayers();
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

    pins.forEach(pin => {
      if (!matchesFilters(pin)) return;
      const marker = L.marker([pin.lat, pin.lng], { icon: createIcon(pin.type, pin.wifi) });
      
      // Use rawAddress for directions. This ensures navigation works based on user input.
      const addressParam = encodeURIComponent(pin.rawAddress);
      const mapsUrl = isIOS 
        ? `http://maps.apple.com/?daddr=${addressParam}&dirflg=d` 
        : `https://www.google.com/maps/dir/?api=1&destination=${addressParam}`;

      const popup = `
        <div style="min-width:200px;">
          <b style="color:#b45309;">${pin.name || 'Unnamed spot'}</b><br>
          <b>${pin.type}</b><br>
          Free Wi‚ÄëFi: <span style="color:${pin.wifi === 'Yes' ? 'green' : 'red'}">${pin.wifi === 'Yes' ? 'Yes' : 'No'}</span><br>
          ${pin.suburb ? `<span>${pin.suburb}</span><br>` : ''}
          ${pin.notes ? `<i>${pin.notes}</i><br>` : ''}<br>
          <a href="${mapsUrl}"
             target="_blank"
             style="color:#b45309;font-weight:bold;">
            üì± Directions
          </a>
        </div>
      `;
      marker.bindPopup(popup);
      marker.addTo(markersLayer);
    });
  }

  function renderPinList() {
    const visiblePins = pins.filter(matchesFilters);
    if (!visiblePins.length) {
      pinList.innerHTML = '<div style="color:#e5e7eb;font-size:0.8rem;">No spots match your filters yet.</div>';
      return;
    }
    pinList.innerHTML = '';
    visiblePins.forEach(pin => {
      const div = document.createElement('div');
      div.className = 'pin-item';
      const span = document.createElement('span');
      span.textContent = `${emoji[pin.type] || 'üìç'} ${pin.name || 'Unnamed'} (${pin.type})${pin.suburb ? ' ‚Äì ' + pin.suburb : ''}`;
      const actions = document.createElement('div');
      actions.className = 'pin-actions';

      const btnEdit = document.createElement('button');
      btnEdit.className = 'btn-edit';
      btnEdit.textContent = 'Edit';
      btnEdit.onclick = () => editPin(pin.id);

      const btnDelete = document.createElement('button');
      btnDelete.className = 'btn-delete';
      btnDelete.textContent = 'Delete';
      btnDelete.onclick = () => deletePin(pin.id);

      actions.appendChild(btnEdit);
      actions.appendChild(btnDelete);
      div.appendChild(span);
      div.appendChild(actions);
      pinList.appendChild(div);
    });
  }

  function editPin(id) {
    const idx = pins.findIndex(p => p.id === id);
    if (idx === -1) return;
    const pin = pins[idx];
    document.getElementById('spot-name').value = pin.name;
    document.getElementById('spot-type').value = pin.type;
    document.getElementById('spot-wifi').value = pin.wifi === 'Yes' ? 'Yes ‚Äì Free Wi‚ÄëFi' : 'No Free Wi‚ÄëFi';
    document.getElementById('spot-address').value = pin.rawAddress || '';
    document.getElementById('spot-notes').value = pin.notes || '';
    pins.splice(idx, 1);
    savePins();
    renderPinsOnMap();
    renderPinList();
    showToast('Loaded spot into form for editing');
  }

  function deletePin(id) {
    if (!confirm('Delete this spot?')) return;
    pins = pins.filter(p => p.id !== id);
    savePins();
    renderPinsOnMap();
    renderPinList();
    showToast('Spot deleted');
  }

  loadPins();
  renderPinsOnMap();
  renderPinList();

  function getUserLocation(initial = false) {
    if (!navigator.geolocation) {
      setStatus('Location not supported by this browser.');
      return;
    }
    setStatus('Finding your location‚Ä¶');
    navigator.geolocation.getCurrentPosition(
      async pos => {
        userLatLng = [pos.coords.latitude, pos.coords.longitude];
        setStatus('Location found.');
        if (!userMarker) {
          userMarker = L.marker(userLatLng, { icon: userVanIcon() })
            .addTo(map)
            .bindPopup('Your location');
        } else {
          userMarker.setLatLng(userLatLng);
        }
        if (initial) {
          map.setView(userLatLng, 13);
        }
        userSuburbGuess = await reverseGeocode(userLatLng[0], userLatLng[1]) || '';
      },
      err => {
        setStatus('Location is disabled. Turn on location in your browser settings.');
      },
      { enableHighAccuracy: true, timeout: 8000 }
    );
  }

  getUserLocation(true);

  overlay.addEventListener('click', function() {
    mapLocked = false;
    overlay.style.display = 'none';
    updateMapLock();
    if (userLatLng) {
      map.setView(userLatLng, 13);
      if (userMarker) userMarker.openPopup();
    } else {
      map.setView([-25.2744, 133.7751], 5);
    }
    setTimeout(() => map.invalidateSize(), 200);
  });

  document.getElementById('refresh-location').addEventListener('click', () => {
    if (userLatLng) {
      map.setView(userLatLng, 13);
      if (userMarker) userMarker.openPopup();
    } else {
      getUserLocation(true);
    }
  });

  document.getElementById('show-my-pins').addEventListener('click', () => {
    const visiblePins = pins.filter(matchesFilters);
    if (!visiblePins.length) {
      showToast('No spots match your filters yet.');
      return;
    }
    const group = L.featureGroup(
      visiblePins.map(p => L.marker([p.lat, p.lng]))
    );
    map.fitBounds(group.getBounds().pad(0.3));
  });

  document.getElementById('show-near-me').addEventListener('click', () => {
    if (!userLatLng) {
      showToast('Need your location first.');
      getUserLocation(true);
      return;
    }
    const maxKm = 10;
    const nearPins = pins.filter(p => {
      const d = distanceKm(userLatLng[0], userLatLng[1], p.lat, p.lng);
      return d <= maxKm && matchesFilters(p);
    });
    if (!nearPins.length) {
      showToast('No spots within 10 km that match filters.');
      return;
    }
    const group = L.featureGroup(
      nearPins.map(p => L.marker([p.lat, p.lng]))
    );
    map.fitBounds(group.getBounds().pad(0.3));
  });

  document.getElementById('add-here').addEventListener('click', async () => {
    if (!userLatLng) {
      showToast('Need your location first.');
      getUserLocation(true);
      return;
    }
    const centre = map.getCenter();
    const approx = await reverseGeocode(centre.lat, centre.lng);
    if (approx) {
      addressInput.value = approx;
      showToast('Approximate address from map centre added.');
    } else {
      addressInput.value = 'Current location';
      showToast('Form set to your current location ‚Äì add name/type and save.');
    }
  });

  document.getElementById('ask-ai').addEventListener('click', () => {
    window.open('https://chatgpt.com', '_blank');
  });

  useMapAddressBtn.addEventListener('click', async () => {
    const centre = map.getCenter();
    setStatus('Getting address from map centre‚Ä¶');
    const approx = await reverseGeocode(centre.lat, centre.lng);
    setStatus('');
    if (approx) {
      addressInput.value = approx;
      showToast('Approximate address added from map centre.');
    } else {
      showToast('Could not get address from map centre.');
    }
  });

  function distanceKm(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2-lat1) * Math.PI/180;
    const dLon = (lon2-lon1) * Math.PI/180;
    const a =
      Math.sin(dLat/2) * Math.sin(dLat/2) +
      Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) *
      Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  async function smartGeocode(rawText) {
    const base = 'https://nominatim.openstreetmap.org/search?format=json&limit=1&countrycodes=au';
    const cleaned = rawText.trim();
    if (!cleaned) return null;

    const tokens = cleaned.split(/\s+/);
    const suburbTail = tokens.slice(-3).join(' ');

    const queries = [];

    queries.push(cleaned);

    if (userLatLng) {
      queries.push(cleaned + ' near ' + userLatLng[0] + ',' + userLatLng[1]);
    }

    if (tokens.length >= 2) {
      queries.push(suburbTail);
    }

    const suburbKeywords = ['coolangatta','ballina','coffs','byron','gold coast','brisbane','sydney','melbourne'];
    const hasSuburb = suburbKeywords.some(k => cleaned.toLowerCase().includes(k));
    if (!hasSuburb && userSuburbGuess) {
      queries.push(cleaned + ' ' + userSuburbGuess);
    }
    if (!hasSuburb) {
      queries.push(cleaned + ' Australia');
    }

    for (let q of queries) {
      const coords = await tryGeocode(base + '&q=' + encodeURIComponent(q));
      if (coords) return coords;
    }
    return null;
  }

  async function tryGeocode(url) {
    try {
      const res = await fetch(url, { headers: { 'Accept-Language': 'en' } });
      const data = await res.json();
      if (!data || !data.length) return null;
      return [parseFloat(data[0].lat), parseFloat(data[0].lon), data[0].display_name || ''];
    } catch(e) {
      return null;
    }
  }

  async function reverseGeocode(lat, lon) {
    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=14&addressdetails=1`;
    try {
      const res = await fetch(url, { headers: { 'Accept-Language': 'en' } });
      const data = await res.json();
      if (!data || !data.address) return '';
      const a = data.address;
      return a.road && a.suburb
        ? `${a.road}, ${a.suburb} ${a.state || ''}`.trim()
        : (a.suburb || a.town || a.city || a.village || a.state || '');
    } catch(e) {
      return '';
    }
  }

  async function addPinFromForm() {
    const now = Date.now();
    if (now - lastSubmitTime < 1500) {
      showToast('Slow down a little‚Äîspot already added.');
      return;
    }
    lastSubmitTime = now;

    const name = document.getElementById('spot-name').value.trim() || 'Unnamed spot';
    const type = document.getElementById('spot-type').value;
    let wifiVal = document.getElementById('spot-wifi').value;
    // Capture the raw address exactly as typed
    const rawAddress = document.getElementById('spot-address').value.trim();
    const notes = document.getElementById('spot-notes').value.trim();
    const coordsVal = document.getElementById('spot-coords').value.trim();

    if (!type || !wifiVal || !rawAddress) {
      showToast('Please fill in all required fields.');
      return;
    }

    wifiVal = wifiVal.startsWith('Yes') ? 'Yes' : 'No';

    let lat, lng;

    if (coordsVal) {
      const parts = coordsVal.split(',');
      if (parts.length === 2) {
        lat = parseFloat(parts[0].trim());
        lng = parseFloat(parts[1].trim());
      }
      if (typeof lat !== 'number' || isNaN(lat) || typeof lng !== 'number' || isNaN(lng)) {
        showToast('Invalid GPS coordinates format');
        return;
      }
    } else {
      // Create a separate variable for searching coordinates so we don't modify rawAddress
      let searchAddress = rawAddress;
      const lowerAddr = searchAddress.toLowerCase();
      const suburbKeywords = ['coolangatta','ballina','coffs','byron','gold coast','brisbane','sydney','melbourne','nsw','qld','vic','sa','wa','tas'];
      const hasSuburb = suburbKeywords.some(k => lowerAddr.includes(k));
      
      // Append user suburb context only for the search query to help finding lat/lng
      if (!hasSuburb && userSuburbGuess) {
        searchAddress = searchAddress + ' ' + userSuburbGuess;
      }

      setStatus('Finding that place‚Ä¶');
      const geo = await smartGeocode(name + ' ' + searchAddress);
      if (!geo) {
        setStatus('');
        alert("Couldn't find that place. Try including a suburb or use the 'Use map centre address' button.");
        return;
      }
      lat = geo[0];
      lng = geo[1];
    }
    
    // Optional: get suburb just for the pin info, but don't overwrite rawAddress
    const suburb = await reverseGeocode(lat, lng);

    const pin = {
      id: Date.now(),
      name,
      type,
      wifi: wifiVal,
      rawAddress: rawAddress, // Save the EXACT user input for navigation
      notes,
      lat,
      lng,
      suburb
    };

    pins.push(pin);
    savePins();
    renderPinsOnMap();
    renderPinList();

    map.setView([lat, lng], 13);
    setStatus('');
    showToast('Spot added!');
  }

  document.getElementById('wifi-form').addEventListener('submit', function(e) {
    e.preventDefault();
    addPinFromForm();
  });

  /* -----------------------------
     STICKY AUTOCOMPLETE LOGIC
     ----------------------------- */

  function showAutocomplete(listEl, items) {
    if (!items.length) {
      listEl.style.display = 'none';
      return;
    }
    listEl.innerHTML = '';
    items.forEach(item => {
      const div = document.createElement('div');
      div.className = 'autocomplete-item';
      div.textContent = item;
      div.addEventListener('mousedown', () => {
        if (listEl === nameAC) nameInput.value = item;
        if (listEl === addressAC) addressInput.value = item;
        listEl.style.display = 'none';
      });
      listEl.appendChild(div);
    });
    listEl.style.display = 'block';
  }

  function stickyAutocomplete(inputEl, listEl, sourceList) {
    inputEl.addEventListener('input', () => {
      const val = inputEl.value.trim().toLowerCase();
      if (!val) {
        listEl.style.display = 'none';
        return;
      }
      const matches = sourceList.filter(x => x.toLowerCase().includes(val));
      showAutocomplete(listEl, matches);
    });

    inputEl.addEventListener('blur', () => {
      setTimeout(() => {
        listEl.style.display = 'none';
      }, 150);
    });
  }

  stickyAutocomplete(nameInput, nameAC, commonNames);
  stickyAutocomplete(addressInput, addressAC, commonAddresses);
  /* -----------------------------
     EXPORT FUNCTION (Advanced Tools)
     ----------------------------- */

  document.getElementById('export-pins').addEventListener('click', () => {
    if (!pins.length) {
      showToast('No spots to export yet.');
      return;
    }
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(pins, null, 2));
    const a = document.createElement('a');
    a.setAttribute("href", dataStr);
    a.setAttribute("download", "my-vanlife-spots.json");
    document.body.appendChild(a);
    a.click();
    a.remove();
    showToast('Your spots have been exported.');
  });

  /* -----------------------------
     ADVANCED TOOLS TOGGLE
     ----------------------------- */

  const advToggle = document.getElementById('advanced-tools-toggle');
  const advPanel = document.getElementById('advanced-tools-panel');

  advToggle.addEventListener('click', () => {
    if (advPanel.style.display === 'block') {
      advPanel.style.display = 'none';
      advToggle.textContent = 'Advanced Tools ‚ñº';
    }
    else {
      advPanel.style.display = 'block';
      advToggle.textContent = 'Advanced Tools ‚ñ≤';
    }
  });

}); // END DOMContentLoaded
</script>

</body>
</html> 








